html
  head
    -
      var cspContent = `
        default-src 'none';
        img-src ${cspSource} https:;
        style-src 'unsafe-inline' https://cdn.jsdelivr.net ${cspSource} https://cdnjs.cloudflare.com;
        script-src 'unsafe-inline' https://cdn.jsdelivr.net ${cspSource};
        font-src *;
      `;
    meta(http-equiv="Content-Security-Policy",  content=cspContent)
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css", media="screen and (prefers-color-scheme: dark)")
    link(rel="stylesheet", type="text/css", href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css")
    link(rel="stylesheet", type="text/css", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css")
    link(rel="stylesheet", type="text/css", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css")
    link(href!=styleURI, rel="stylesheet")
    script(src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js")

  body

    - var false_positive_reason = vulnerability.auto_fix_suggestion.status === "false_positive" ? vulnerability.auto_triage.false_positive_detection.reasoning : ''
    h3.d-flex.align-items-center
      img(src!=logoURI, alt="Logo", width="50")
      a(href!=`command:vscode.open?${encodeURIComponent(JSON.stringify(fileURI))}`) !{vulnerability.location.file.path}: !{vulnerability.location.line_number}
    strong
      span.mr-2(class=`${vulnerability.urgency} severity`) !{vulnerability.urgency}
    span.text-white !{vulnerability.classification.name}
    hr
    a(href=`command:vscode.open?${corgeaURI}`)
      button.btn-secondary.mr-2 See on Corgea
    if vulnerability.auto_fix_suggestion.status === "on_hold"
      .card
        .card-header Could Not Issue Fix
        if vulnerability.auto_fix_suggestion.status === "unsupported"
          .card-body
            p.fix_explanation.text-white Corgea currently does not support this language.
        else if vulnerability.auto_fix_suggestion.status === "plan"
          .card-body
            p.fix_explanation.text-white You've reached the limit of your plan. Please upgrade to get all the fixes.
        else if vulnerability.auto_fix_suggestion.status === "false_positive"
          .card-body
            p.fix_explanation
              h3.text-white False Positive Detected
              span.text-white !{false_positive_reason}
        else if vulnerability.auto_fix_suggestion.status === "gpt_error"
          .card-body
            p.fix_explanation.text-white Corgea was unable to generate a fix for this issue. This was likely due to insufficient context or failing QA checks.
        else
          .card-body
            p.fix_explanation.text-white Corgea was unable to generate a fix for this issue due to AI limitations.
    else
      if vulnerability.auto_fix_suggestion.patch && vulnerability.auto_fix_suggestion.patch.diff
        button.btn-primary(onclick="applyDiff()") Apply Fix
        br
        br
        .card.w-100
          .card-header.suggested-change
            span Suggested Change
            div 
              .btn-group.ms-2(role='group' aria-label='Basic outlined example')
                button#btnLineByLine.btn.btn-secondary.btn-sm(type='button' data-bs-toggle='tooltip' data-bs-placement='top' title='Line-by-line view', onclick="load('line-by-line'); updateIcons('line-by-line');")
                  span#iconLineByLine.fa.fa-bars
                button#btnSideBySide.btn.btn-secondary.btn-sm(type='button' data-bs-toggle='tooltip' data-bs-placement='top' title='Side-by-side view', onclick="load('side-by-side'); updateIcons('side-by-side');")
                  span#iconSideBySide.fa.fa-columns

          .card-body.p-0
            #diffElement
        
        br
        br
        .card-wrapper 
          .card.split-view
            .card-header Issue Explanation
            .card-body
              p.issue_explanation.text-white !{vulnerability.details.explanation}
          .card.split-view
            .card-header Fix Explanation
            .card-body
              p.fix_explanation.text-white !{vulnerability.auto_fix_suggestion.patch.explanation}

        script.
          const diffString = decodeURIComponent(escape(window.atob("!{diffString}")));
          async function load(outputFormat) {
            var targetElement = document.getElementById('diffElement');
            var configuration = {
                drawFileList: false,
                fileListToggle: true,
                fileListStartVisible: true,
                fileContentToggle: false,
                matching: 'lines',
                outputFormat: outputFormat,
                synchronisedScroll: true,
                highlight: true,
                renderNothingWhenEmpty: false,
                colorScheme: 'dark',

            };
            diff2htmlUi = new Diff2HtmlUI(targetElement, diffString, configuration);
            diff2htmlUi.draw();
            diff2htmlUi.highlightCode();
          }



          function updateIcons(selectedFormat) {
              const sideBySideIcon = document.getElementById('iconSideBySide');
              const lineByLineIcon = document.getElementById('iconLineByLine');
              if (selectedFormat === 'side-by-side') {
                  sideBySideIcon.classList.add('text-info');
                  lineByLineIcon.classList.remove('text-info');
              } else {
                  lineByLineIcon.classList.add('text-info');
                  sideBySideIcon.classList.remove('text-info');
              }
          }

          document.addEventListener('DOMContentLoaded', function () {
            const defaultDiffView = 'side-by-side';
            load(defaultDiffView);
            updateIcons(defaultDiffView);
          });

          const vscode = acquireVsCodeApi();

          function applyDiff() {
            const diff = diffString;
            vscode.postMessage({
                command: 'applyDiff',
                fileUri: `!{fileURI.scheme}:!{fileURI.path}#!{fileURI.fragment}`,
                diff: diff
            });
          }
      else
        .card
          .card-header Fix In Progress
          .card-body
            p.fix_explanation.text-white Corgea is processing the issue and will create a fix soon. Please check again later.
